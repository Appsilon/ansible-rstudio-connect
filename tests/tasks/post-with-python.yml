# post test file for with-python scenario
---
- name: Test rstudio-connect installation
  ansible.builtin.uri:
    url: http://localhost:3939/__ping__
    status_code:
      - 200
      - 402

- name: Read RStudio Connect config file
  ansible.builtin.command: cat /etc/rstudio-connect/rstudio-connect.gcfg
  changed_when: false
  register: connect_config

- name: Debug
  ansible.builtin.debug:
    msg: "{{ connect_config.stdout }}"

- name: Assert Python is enabled
  ansible.builtin.assert:
    that:
      - connect_config.stdout.find("[Python]\nEnabled = true") != -1
    fail_msg: "Python is disabled"

- name: Assert Python executables are present
  ansible.builtin.assert:
    that:
      - connect_config.stdout.find("Executable = /opt/python/{{ item }}/bin/python3") != -1
    fail_msg: "Executable for {{ item }} is not set"
  loop: "{{ python_versions }}"
